---
title: API Reference
description: Complete Edge Functions documentation
icon: code
---
# API Reference - Edge Functions

This document provides complete reference documentation for all Supabase Edge Functions in the API Docs to MCP Server platform.

## Overview

The platform uses Supabase Edge Functions to handle the complete workflow from document processing to MCP server deployment. See `supabase/functions/` directory for the complete list.

### Core Functions
- **`ai-doc-to-mcp`** - Converts documents (PDF, DOCX, etc.) to OpenAPI specifications using AI
- **`validate-openapi`** - Validates and stores OpenAPI specifications
- **`rate-limited-validate-openapi`** - Rate-limited version of validation
- **`generate-mcp-server`** - Generates MCP 2025-03-26 compliant servers
- **`mcp-router`** - Routes requests to deployed MCP servers with OAuth/JWT validation
- **`mcp-oauth-server`** - OAuth 2.1 authorization server for Claude MCP clients
- **`manage-deployment`** - Manages deployment lifecycle

### Email Functions

> **âš ï¸ STATUS:** The following email functions are DISABLED as of 2025-01-23.  
> See [Email Authentication](../operations/EMAIL_AUTHENTICATION.md) for details.

- **`send-auth-email`** - âš ï¸ **DISABLED** - Sends email verification via Resend
  - Status: Commented out, not deployed
  - Replacement: Supabase built-in email sending
  
- **`verify-email`** - âš ï¸ **DISABLED** - Verifies email verification tokens
  - Status: Commented out, not deployed
  - Replacement: Supabase automatic verification
  
- **`create-verification-token`** - âš ï¸ **DISABLED** - Generates and sends email verification tokens
  - Status: Commented out, not deployed
  - Replacement: Supabase auth.signUp() automatic email
  
- **`resend-verification-email`** - âš ï¸ **DISABLED** - Resends verification emails with rate limiting
  - Status: Commented out, not deployed
  - Replacement: Supabase auth.resend()

**Still Active:**
- **`auth-login`** - âœ… **ACTIVE** - Custom login handler with email verification check
  - Checks `email_confirmed_at` field set by Supabase
  - Works with both custom and Supabase verification systems

### Supporting Functions

### Deprecated/One-Time Functions
- **`fix-cors-headers`** - âš ï¸ One-time migration script (not an active feature)
- **`secure-mcp-router`** - âš ï¸ DISABLED due to security vulnerabilities (use `mcp-router` instead)

## Authentication Token Types

âš ï¸ **Important**: The platform uses TWO distinct authentication systems. Understanding the difference is critical for security.

### Platform JWT Tokens (Supabase Auth)

**Purpose**: Authenticate users to the Tydli platform and edge functions

**Characteristics**:
- **Format**: Standard JWT with header, payload, and signature
- **Lifetime**: ~1 hour (session-based)
- **Auto-refresh**: Supabase client handles automatic renewal
- **Auto-invalidate**: Session-tied; logging out ends validity
- **Security**: Verified cryptographically using JWT signature

**Usage**:
- Calling Tydli edge functions (`/validate-openapi`, `/generate-mcp-server`, etc.)
- Managing deployments via the platform API
- Accessing user-specific resources

**Example Header**:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Deployment Bearer Tokens (Static Authentication)

**Purpose**: Authenticate AI agents to specific MCP deployments when `mcp_auth_method = 'jwt'`

**Characteristics**:
- **Format**: Random base64url-encoded string (32 bytes) - **NOT a JWT**
- **Lifetime**: Never expires (static)
- **Auto-refresh**: Not applicable (static token)
- **Auto-invalidate**: Only via manual deletion of deployment
- **Security**: Simple bearer token matching (no cryptographic verification)
- **Storage**: `deployments.mcp_jwt_token` field in database

**Usage**:
- MCP server access via `mcp-router` when deployment uses JWT auth method
- Alternative to OAuth 2.1 for deployments (OAuth recommended)
- Used by AI agents that cannot perform OAuth flows

**Example Header**:
```
Authorization: Bearer x7k9mPqR2vN8wL4jT6hY3zF1bC5nA9sD
```

**Security Warning**: Because these tokens never expire and are not cryptographically secured like JWTs, they should be:
- Treated as sensitive credentials (like API keys)
- Stored securely and never committed to version control
- Rotated by deleting and recreating the deployment
- Used only when OAuth 2.1 is not feasible

### Choosing the Right Token

| Scenario | Use This Token |
|----------|---------------|
| Calling Tydli platform APIs | Platform JWT Token (Supabase Auth) |
| Managing deployments | Platform JWT Token (Supabase Auth) |
| MCP server access (recommended) | OAuth 2.1 (not a token, but a flow) |
| MCP server access (alternative) | Deployment Bearer Token |
| Testing/development MCP access | Deployment Bearer Token (set `mcp_auth_method='jwt'`) |

## Error Handling

All edge functions return errors in a standardized format for consistent client-side handling.

### Standard Error Response

```json
{
  "error": "ERROR_CODE",
  "message": "Human-readable error message",
  "details": "Optional additional context for the user",
  "request_id": "uuid-for-correlation"
}
```

### Common Error Codes

| Code | Status | Description |
|------|--------|-------------|
| `INVALID_TOKEN` | 401 | JWT token is invalid or expired |
| `UNAUTHORIZED` | 401 | Missing authentication |
| `EMAIL_NOT_VERIFIED` | 401 | Email verification required |
| `FORBIDDEN` | 403 | Insufficient permissions |
| `INVALID_INPUT` | 400 | Invalid request parameters |
| `INVALID_FORMAT` | 400 | Invalid data format (e.g., URL format, YAML parsing) |
| `VALIDATION_FAILED` | 400 | OpenAPI validation failed |
| `MISSING_REQUIRED_FIELD` | 400 | Required field missing |
| `RATE_LIMIT_EXCEEDED` | 429 | Too many requests |
| `QUOTA_EXCEEDED` | 429 | Usage quota exceeded |
| `NOT_FOUND` | 404 | Resource not found |
| `DEPLOYMENT_NOT_FOUND` | 404 | Deployment does not exist |
| `SPEC_NOT_FOUND` | 404 | API specification not found |
| `ALREADY_EXISTS` | 409 | Resource already exists |
| `SPEC_TOO_LARGE` | 400 | File size exceeds limit |
| `INTERNAL_ERROR` | 500 | Server error occurred |
| `DATABASE_ERROR` | 500 | Database operation failed |
| `ENCRYPTION_FAILED` | 500 | Credential encryption failed |
| `EXTERNAL_API_ERROR` | 502 | External service unavailable |
| `AI_PROCESSING_FAILED` | 502 | AI processing failed |
| `EMAIL_SEND_FAILED` | 502 | Email delivery failed |

### Error Correlation

All errors include a `request_id` for troubleshooting. Use this ID when:
- Reporting issues to support
- Searching deployment logs
- Correlating PostHog events

**Query deployment logs by request_id:**
```sql
SELECT * FROM deployment_logs 
WHERE error_details->>'request_id' = 'your-request-id'
ORDER BY created_at DESC;
```

### Error Handling Best Practices

1. **Always check error codes** - Use error codes for conditional logic, not HTTP status codes
2. **Display user-friendly messages** - Show the `message` field to users
3. **Log request_id** - Store request_id for support tickets
4. **Handle rate limits** - Implement exponential backoff for 429 errors
5. **Retry on server errors** - Retry 500-level errors with backoff

## MCP Server Endpoints

## Primary MCP Endpoints

MCP servers can be accessed via two equivalent endpoints:
- **`POST /messages`** - Standard MCP JSON-RPC endpoint
- **`POST /`** - Base URL endpoint (mcp-remote compatibility)

Both endpoints accept identical JSON-RPC requests and return identical responses.

### Metadata Discovery

**Endpoint:** `GET /.well-known/mcp-server`  
**Authentication:** Not required  
**Description:** Returns complete MCP server metadata for client auto-discovery

**Response:**
```json
{
  "protocol_version": "2025-03-26",
  "server_info": {
    "name": "your-api-mcp-server",
    "version": "0.1.0",
    "description": "MCP server generated from OpenAPI specification"
  },
  "capabilities": {
    "tools": true,
    "resources": false,
    "prompts": false
  },
  "endpoints": {
    "tools": "https://.../tool",
    "resources": "https://.../resources",
    "prompts": "https://.../prompts",
    "health": "https://.../health",
    "docs": "https://.../docs"
  },
  "authentication": {
    "required": true,
    "methods": ["bearer"],
    "oauth_server": "https://.../.well-known/oauth-authorization-server"
  }
}
```

**Headers:**
```
MCP-Protocol-Version: 2025-03-26
Content-Type: application/json
```

### Tools List

**Endpoint:** `GET /tool`  
**Authentication:** Bearer token required  
**Description:** Returns all available tools

**Request:**
```
GET /tool
Authorization: Bearer mcp_access_xxxxx
```

**Response:**
```json
{
  "tools": [
    {
      "name": "get_users",
      "description": "Retrieve list of users",
      "inputSchema": {
        "type": "object",
        "properties": {
          "limit": { "type": "integer", "description": "Max results" },
          "offset": { "type": "integer", "description": "Skip results" }
        },
        "required": ["limit"]
      },
      "outputSchema": {
        "type": "object",
        "properties": {
          "users": { "type": "array" }
        }
      }
    }
  ],
  "count": 1
}
```

### Tool Metadata

**Endpoint:** `GET /tool/{toolName}`  
**Authentication:** Bearer token required  
**Description:** Returns detailed metadata for a specific tool

**Response:** Same structure as individual tool object from tools list

### Tool Execution

**Endpoint:** `POST /tool/{toolName}`  
**Authentication:** Bearer token required  
**Description:** Execute a tool with provided arguments

**Request:**
```json
{
  "arguments": {
    "limit": 10,
    "offset": 0
  }
}
```

**Success Response:**
```json
{
  "result": {
    "users": [
      { "id": 1, "name": "Alice" },
      { "id": 2, "name": "Bob" }
    ]
  }
}
```

**Error Response:**
```json
{
  "error": "Tool execution failed",
  "message": "HTTP 404: Not Found",
  "details": "..."
}
```

### Resources Endpoint

**Endpoint:** `GET /resources`  
**Authentication:** Bearer token required  
**Description:** Lists available MCP resources

**Response:**
```json
{
  "resources": [],
  "description": "No resources available for this API"
}
```

### Prompts Endpoint

**Endpoint:** `GET /prompts`  
**Authentication:** Bearer token required  
**Description:** Lists available MCP prompts

**Response:**
```json
{
  "prompts": [],
  "description": "No prompts available for this API"
}
```

### Health Check

**Endpoint:** `GET /health`  
**Authentication:** Not required  
**Description:** Server health status

**Response:**
```json
{
  "status": "healthy",
  "timestamp": "2025-01-04T12:00:00.000Z"
}
```

### Documentation

**Endpoint:** `GET /docs`  
**Authentication:** Not required  
**Description:** Human-readable API documentation

**Response:** Complete server documentation including tools, authentication config, and usage examples

### Base URL Endpoint (mcp-remote compatibility)

**Endpoint:** `POST /`  
**Authentication:** Same as `/messages` endpoint  
**Description:** Base URL accepts JSON-RPC requests and routes them to `/messages` handler

**Purpose:** Some MCP clients (like `mcp-remote` proxy) send JSON-RPC requests to the base URL instead of `/messages`. This endpoint provides compatibility with those clients while maintaining backward compatibility for discovery requests.

**Request:**
```json
POST /
Content-Type: application/json

{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/list",
  "params": {}
}
```

**Response:**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "tools": [...]
  }
}
```

**Behavior:**
- âœ… **JSON-RPC requests** (with `jsonrpc: "2.0"` and `method` field) â†’ Routed to `/messages` handler
- âœ… **Non-JSON-RPC POST requests** â†’ Returns discovery metadata
- âœ… **GET requests** â†’ Returns discovery metadata (unchanged)
- âœ… **All JSON-RPC methods supported:** `initialize`, `tools/list`, `tools/call`

**Implementation Note:** The base URL handler reads the request body once, detects JSON-RPC format, then reconstructs a new Request object and forwards to `/messages`. This avoids "Body already consumed" errors while maintaining DRY principles.

## Authentication

The platform supports three authentication methods:

### 1. OAuth 2.1 with PKCE (Recommended for AI Agents)

For Claude-compatible AI agents and MCP clients, use OAuth 2.1 with PKCE:

**Discovery Endpoint**: `/.well-known/oauth-authorization-server`  
**Authorization Endpoint**: `/authorize`  
**Token Endpoint**: `/token`  
**Registration Endpoint**: `/register`

**Supported Features**:
- Authorization Code Grant with PKCE (S256)
- Dynamic client registration
- Session-based consent flow
- Access token validation
- Rate limiting

**Client Configuration** (Claude Desktop/Claude.ai):

**IMPORTANT:** Remote MCP servers with OAuth must be configured via **Settings > Connectors**, not configuration files.

1. Open Claude Desktop â†’ **Settings â†’ Connectors** (or https://claude.ai/settings/connectors for web)
2. Click **"Add custom connector"**
3. Enter the following:
   - **Name**: `Tydli - [your-deployment-slug]`
   - **MCP Server URL**: `https://nqfciqtsrcjorlqcglmq.supabase.co/functions/v1/mcp-router/[your-slug]`
   - **OAuth Client ID**: (from your deployment dashboard)
   - **Authorization URL**: `https://nqfciqtsrcjorlqcglmq.supabase.co/functions/v1/mcp-oauth-server/authorize`
   - **Token URL**: `https://nqfciqtsrcjorlqcglmq.supabase.co/functions/v1/mcp-oauth-server/token`
4. Click **Connect** - your browser will open for authorization

**Note:** This uses OAuth 2.1 with PKCE. No client secret is required.

### 2. Platform JWT Authentication (For Tydli API Access)

For direct access to Tydli platform APIs (deployment management, validation, etc.), use Supabase JWT authentication:

**Required Header**:
```
Authorization: Bearer <platform-jwt-token>
```

**Getting Your Platform JWT Token**:
1. Sign up/log in to the Tydli platform
2. Use your browser's developer tools to inspect the session
3. Extract the JWT token from the Supabase Auth session
4. Or use the Supabase JavaScript client: `supabase.auth.getSession()`

**Authentication Flow**:
1. User signs up/logs in via Supabase Auth
2. Email verification required (auto-confirm is FALSE)
3. Frontend receives JWT token after verification
4. Token included in all Tydli platform API requests
5. Edge Functions validate token and extract user context

**Token Management** (Platform JWT):
- **Session-Tied**: Tokens remain valid for the duration of your session (~1 hour)
- **Auto-Invalidate**: Tokens automatically invalidate when you log out
- **Auto-Refresh**: Supabase client handles token refresh automatically
- **Security**: Cryptographically signed JWT tokens with user claims

**Token Security**:
- Never share your JWT tokens publicly
- Tokens are tied to your user session for isolation
- Log out to invalidate all active tokens
- Use secure storage when integrating with external tools

**Note**: This is different from MCP deployment authentication. For MCP server access, see the "Authentication Token Types" section above.

### 3. No Authentication (Public Access)

For deployments configured with `mcp_auth_method = 'none'`, no authentication is required. Usage is still tracked against the deployment owner's account.

### Protected vs Public Endpoints

**Protected Endpoints** (Require JWT):
- `ai-doc-to-mcp` - AI document processing
- `validate-openapi` - User-scoped validation and storage
- `rate-limited-validate-openapi` - Rate-limited validation
- `generate-mcp-server` - User-owned deployment creation  
- `manage-deployment` - User-owned deployment management
- `store-credentials` - Credential encryption
- `retrieve-credentials` - Credential decryption
- `posthog-analytics` - Analytics events
- `create-verification-token` - Email verification token generation (public token generation)
- `fetch-url` - URL fetching (requires authentication)
- `fix-cors-headers` - Internal CORS management

**Public Endpoints** (No JWT Required):
- `mcp-oauth-server` - OAuth authorization server (verify_jwt = false)
- `send-auth-email` - Email sending (verify_jwt = false)
- `verify-email` - Email verification (verify_jwt = false)

**Variable Authentication**:
- `mcp-router` - Base endpoint is public (verify_jwt = false), but authentication is handled internally based on deployment's `mcp_auth_method` setting (OAuth/JWT/None)

---

## 1. validate-openapi

**Purpose**: Validate OpenAPI specifications and store in database

**Authentication**: Required  
**URL**: `/functions/v1/validate-openapi`  
**Method**: POST

### Request Body

```typescript
interface ValidationRequest {
  content: object;                    // Parsed OpenAPI specification
  format: 'json' | 'yaml';           // Source format
  source_type: 'upload' | 'paste' | 'url';  // Input method
  source_url?: string;               // URL if source_type is 'url'
  name: string;                      // API specification name
  file_data?: string;                // Base64 encoded file content (for uploads)
  file_size?: number;                // File size in bytes (for uploads)
}
```

### Response

```typescript
interface ValidationResponse {
  valid: boolean;                    // Whether specification is valid
  version?: string;                  // OpenAPI version (e.g., "3.0.1")
  endpoint_count?: number;           // Number of endpoints found
  errors?: string[];                 // Validation error messages
  api_spec_id?: string;             // Database ID if validation succeeds
  endpoints?: Array<{               // Parsed endpoint details
    path: string;
    method: string;
    operation_id?: string;
    summary?: string;
    description?: string;
    parameters: Array<{
      name: string;
      in: 'query' | 'path' | 'header' | 'cookie';
      required: boolean;
      schema: object;
    }>;
    request_schema?: object;
    response_schema?: object;
  }>;
}
```

### Example Request

```bash
curl -X POST \
  'https://nqfciqtsrcjorlqcglmq.supabase.co/functions/v1/validate-openapi' \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "content": {
      "openapi": "3.0.1",
      "info": {
        "title": "Pet Store API",
        "version": "1.0.0"
      },
      "paths": {
        "/pets": {
          "get": {
            "summary": "List pets",
            "responses": {
              "200": {
                "description": "List of pets"
              }
            }
          }
        }
      }
    },
    "format": "json",
    "source_type": "paste",
    "name": "Pet Store API"
  }'
```

### Example Response

```json
{
  "valid": true,
  "version": "3.0.1",
  "endpoint_count": 1,
  "api_spec_id": "123e4567-e89b-12d3-a456-426614174000",
  "endpoints": [
    {
      "path": "/pets",
      "method": "GET",
      "summary": "List pets",
      "parameters": [],
      "response_schema": {
        "type": "object",
        "properties": {
          "description": {
            "type": "string"
          }
        }
      }
    }
  ]
}
```

### Error Responses

**400 Bad Request**
```json
{
  "valid": false,
  "errors": [
    "Missing required field: info.title",
    "OpenAPI version must be 3.0 or higher"
  ]
}
```

**401 Unauthorized**
```json
{
  "error": "Unauthorized: Invalid JWT token"
}
```

**500 Internal Server Error**
```json
{
  "error": "Validation failed: Internal server error"
}
```

---

## 2. generate-mcp-server

**Purpose**: Generate MCP server code and deploy as Edge Function

**Authentication**: Required  
**URL**: `/functions/v1/generate-mcp-server`  
**Method**: POST

### Request Body

```typescript
interface GenerationRequest {
  api_spec_id: string;              // Reference to validated API spec
  deployment_name: string;          // Name for the deployment
}
```

### Response

```typescript
interface GenerationResponse {
  deployment_id: string;            // Unique deployment identifier
  status: 'generating';             // Initial status
  message: string;                  // Status message
}
```

### Example Request

```bash
curl -X POST \
  'https://nqfciqtsrcjorlqcglmq.supabase.co/functions/v1/generate-mcp-server' \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "api_spec_id": "123e4567-e89b-12d3-a456-426614174000",
    "deployment_name": "pet-store-api"
  }'
```

### Example Response

```json
{
  "deployment_id": "456e7890-e89b-12d3-a456-426614174111",
  "status": "generating",
  "message": "MCP server generation started"
}
```

### Generated MCP Server Structure

The function generates compliant MCP servers with:

- **Tool definitions** for each API endpoint
- **Parameter validation** based on OpenAPI schemas
- **Error handling** with proper HTTP status codes
- **CORS support** for web-based AI agents
- **Health check endpoint** at `/health`

### Error Responses

**404 Not Found**
```json
{
  "error": "API specification not found"
}
```

**500 Internal Server Error**
```json
{
  "error": "MCP server generation failed: <specific error>"
}
```

---

## 3. mcp-oauth-server

**Purpose**: OAuth 2.1 authorization server for Claude-compatible MCP clients

**Base URL**: `/functions/v1/mcp-oauth-server`  
**Specification**: OAuth 2.1, RFC 6749, RFC 7636 (PKCE)

### Endpoints

#### GET /.well-known/oauth-authorization-server

Returns OAuth server metadata for automatic client configuration.

**Response**:
```json
{
  "issuer": "https://nqfciqtsrcjorlqcglmq.supabase.co/functions/v1/mcp-oauth-server",
  "authorization_endpoint": ".../authorize",
  "token_endpoint": ".../token",
  "registration_endpoint": ".../register",
  "scopes_supported": ["openid", "email", "profile"],
  "response_types_supported": ["code"],
  "grant_types_supported": ["authorization_code"],
  "code_challenge_methods_supported": ["S256"]
}
```

#### POST /register

Register a new OAuth client dynamically.

**Request Body**:
```json
{
  "client_name": "My AI Agent",
  "redirect_uris": ["http://localhost:3000/callback"],
  "scope": "openid email",
  "metadata": {
    "deployment_id": "optional-deployment-id"
  }
}
```

**Response**:
```json
{
  "client_id": "mcp_abc123...",
  "client_secret": "secret_xyz789...",
  "client_name": "My AI Agent",
  "redirect_uris": ["http://localhost:3000/callback"],
  "token_endpoint_auth_method": "client_secret_post"
}
```

#### GET /authorize

Initiate OAuth authorization flow. Requires user authentication via session.

**Query Parameters**:
- `client_id` (required): OAuth client ID
- `response_type` (required): Must be "code"
- `redirect_uri` (required): Registered redirect URI
- `scope` (optional): Requested scopes (default: "openid email")
- `state` (optional): Client state for CSRF protection
- `code_challenge` (required): PKCE code challenge (S256)
- `code_challenge_method` (required): Must be "S256"

**Flow**:
1. If not authenticated â†’ Shows login page
2. After login â†’ Shows consent page
3. After approval â†’ Redirects to `redirect_uri?code=...&state=...`

#### POST /token

Exchange authorization code for access token.

**Request Body**:
```json
{
  "grant_type": "authorization_code",
  "code": "code_abc123...",
  "redirect_uri": "http://localhost:3000/callback",
  "client_id": "mcp_abc123...",
  "code_verifier": "random_verifier_string"
}
```

**Response**:
```json
{
  "access_token": "mcp_access_xyz789...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "scope": "openid email"
}
```

### Security Features

- **PKCE Required**: All authorization flows must use S256 code challenge
- **Rate Limiting**: 
  - 10 registrations per hour per IP
  - 20 authorization requests per hour per IP
  - 10 token requests per minute per client
- **Session Security**: Login sessions expire after 5 minutes
- **HTTPS Required**: Except for localhost redirect URIs
- **No Wildcard Domains**: Redirect URIs must be exact matches

---

## 4. mcp-router

**Purpose**: Route incoming requests to deployed MCP servers

**Authentication**: OAuth 2.1 Bearer Token (Recommended) or JWT  
**URL**: `/functions/v1/mcp-router/{slug}/{...path}`  
**Method**: ALL (GET, POST, PUT, DELETE, etc.)

### URL Structure

```
/functions/v1/mcp-router/{deployment-slug}/{mcp-endpoint-path}
```

- `{deployment-slug}`: Unique identifier for the deployment
- `{mcp-endpoint-path}`: MCP-specific path (usually empty for root)

**Historical Note**: The endpoint was previously named `secure-mcp-router` but has been renamed to `mcp-router`. The old endpoint name has been disabled.

### Security Features

The router provides:
- **OAuth 2.1 Authentication**: Recommended for AI agents (PKCE-based)
- **JWT Authentication**: Alternative for direct API access and testing
- **Sandboxed Execution**: MCP server code runs in isolated environment
- **Rate Limiting**: Per-user request limits enforced
- **Resource Limits**: CPU and memory constraints for safety
- **Request Logging**: Comprehensive usage tracking

### Headers

Required headers (one of):
- `Authorization: Bearer <mcp_access_token>` - OAuth 2.1 access token (recommended for AI agents)
- `Authorization: Bearer <jwt-token>` - Supabase JWT token (for direct access)

The router forwards all other headers and adds:
- `Access-Control-Allow-Origin: *`
- `Access-Control-Allow-Headers: authorization, x-client-info, apikey, content-type`

### OAuth Token Validation

When using OAuth Bearer tokens (starting with `mcp_access_`):
- Validates token exists in `oauth_access_tokens` table
- Checks token not revoked
- Verifies token not expired
- Associates request with authenticated user
- Returns 401 if validation fails

### Example Usage

**Get MCP Server Info**
```bash
curl -X GET \
  'https://nqfciqtsrcjorlqcglmq.supabase.co/functions/v1/mcp-router/pet-store-api-xyz123' \
  -H 'Authorization: Bearer <jwt-token>'
```

**Call MCP Tool**
```bash
curl -X POST \
  'https://nqfciqtsrcjorlqcglmq.supabase.co/functions/v1/mcp-router/pet-store-api-xyz123' \
  -H 'Authorization: Bearer <jwt-token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "method": "tools/call",
    "params": {
      "name": "list_pets",
      "arguments": {}
    }
  }'
```

### Response

The router returns responses directly from the target MCP server:

**MCP Server Info**
```json
{
  "protocol": "mcp",
  "version": "1.0.0",
  "tools": [
    {
      "name": "list_pets",
      "description": "List pets",
      "inputSchema": {
        "type": "object",
        "properties": {}
      }
    }
  ]
}
```

### Error Responses

**404 Not Found**
```json
{
  "error": "MCP server not found or inactive",
  "slug": "pet-store-api-xyz123"
}
```

**401 Unauthorized**
```json
{
  "error": "Authentication required",
  "details": "Valid JWT token required to access MCP server"
}
```

**429 Too Many Requests**
```json
{
  "error": "Rate limit exceeded",
  "details": "User has exceeded hourly request limit"
}
```

**500 Internal Server Error**
```json
{
  "error": "MCP server execution failed",
  "details": "Server code execution timeout or error"
}
```

### Rate Limiting

The secure MCP router enforces per-user rate limits:

- **Hourly Limits**: Typically 20 requests per hour for free users
- **Monthly Limits**: Typically 1000 requests per month for free users
- **Enforcement**: Limits checked before server execution
- **Response**: 429 status code when exceeded

Rate limits can be checked via the database functions:
```sql
SELECT * FROM check_rate_limits('user-id-here');
```

---

## 5. manage-deployment

**Purpose**: Manage deployment lifecycle and retrieve operational data

**Authentication**: Required  
**URL**: `/functions/v1/manage-deployment`  
**Method**: POST

### Request Body

```typescript
interface ManagementRequest {
  deployment_id: string;                           // Target deployment ID
  action: 'start' | 'stop' | 'status' | 'logs' | 'health';  // Action to perform
  limit?: number;                                  // For 'logs' action (default: 100)
}
```

### Actions

#### start
Activates a stopped deployment by updating the MCP server registry.

**Response**:
```typescript
{
  success: boolean;
  message: string;
  status?: string;  // New deployment status
}
```

#### stop
Deactivates a running deployment.

**Response**:
```typescript
{
  success: boolean;
  message: string;
  status?: string;  // New deployment status
}
```

#### status
Retrieves current deployment and MCP server status.

**Response**:
```typescript
{
  deployment: {
    id: string;
    name: string;
    status: 'generating' | 'ready' | 'stopped' | 'error';
    created_at: string;
    updated_at: string;
    mcp_server_url?: string;
    endpoint_count?: number;
    error_message?: string;
  };
  mcp_server?: {
    id: string;
    slug: string;
    status: 'active' | 'inactive';
    created_at: string;
    updated_at: string;
  };
}
```

#### logs
Retrieves deployment logs with optional limit.

**Response**:
```typescript
{
  logs: Array<{
    id: string;
    level: 'info' | 'error' | 'debug' | 'warn';
    message: string;
    metadata: object;
    created_at: string;
  }>;
  total_count: number;
}
```

#### health
Performs health check on the deployed MCP server.

**Response**:
```typescript
{
  healthy: boolean;
  response_time_ms?: number;
  status_code?: number;
  error?: string;
  checked_at: string;
}
```

### Example Requests

**Start Deployment**
```bash
curl -X POST \
  'https://nqfciqtsrcjorlqcglmq.supabase.co/functions/v1/manage-deployment' \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "deployment_id": "456e7890-e89b-12d3-a456-426614174111",
    "action": "start"
  }'
```

**Get Status**
```bash
curl -X POST \
  'https://nqfciqtsrcjorlqcglmq.supabase.co/functions/v1/manage-deployment' \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "deployment_id": "456e7890-e89b-12d3-a456-426614174111",
    "action": "status"
  }'
```

**Get Recent Logs**
```bash
curl -X POST \
  'https://nqfciqtsrcjorlqcglmq.supabase.co/functions/v1/manage-deployment' \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "deployment_id": "456e7890-e89b-12d3-a456-426614174111",
    "action": "logs",
    "limit": 50
  }'
```

### Error Responses

**403 Forbidden**
```json
{
  "error": "Deployment not found or access denied"
}
```

**400 Bad Request**
```json
{
  "error": "Invalid action specified"
}
```

---

## Rate Limits and Quotas

### Function Execution Limits
- **Timeout**: 30 seconds per function execution
- **Memory**: 512MB per function instance
- **Concurrent executions**: Auto-scaled by Supabase

### Request Limits
- **Body size**: 10MB maximum
- **Rate limiting**: Per-user limits enforced by database functions
  - Free tier: 20 requests/hour, 1000 requests/month
  - Rate limits checked before function execution
  - 429 status code returned when exceeded

### User Quotas
- **Deployments**: 10 deployments per user (free tier)
- **Endpoints per deployment**: 50 endpoints maximum
- **Total endpoints**: 100 endpoints across all deployments
- **Quotas enforced**: Before deployment creation and MCP server access

### Storage Limits
- **API specifications**: 10MB per file
- **Database storage**: Limited by Supabase plan
- **Logs retention**: 30 days (configurable)

## Error Handling

### Common HTTP Status Codes

- **200 OK**: Successful operation
- **400 Bad Request**: Invalid request parameters or body
- **401 Unauthorized**: Missing or invalid JWT token
- **403 Forbidden**: Insufficient permissions
- **404 Not Found**: Resource not found
- **429 Too Many Requests**: Rate limit exceeded
- **500 Internal Server Error**: Server-side error

### Error Response Format

All functions return errors in a consistent format:
```json
{
  "error": "Human-readable error message",
  "details?": "Additional technical details",
  "code?": "ERROR_CODE_CONSTANT"
}
```

### Debugging Tips

1. **Check deployment logs** for detailed error information
2. **Verify authentication** tokens are valid and not expired
3. **Validate request bodies** match the expected schema
4. **Monitor function execution time** for timeout issues
5. **Check database permissions** for RLS policy violations

---

## SDK and Integration Examples

### JavaScript/TypeScript

```typescript
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  'https://nqfciqtsrcjorlqcglmq.supabase.co',
  'your-anon-key'
);

// Validate OpenAPI spec
const { data, error } = await supabase.functions.invoke('validate-openapi', {
  body: {
    content: openApiSpec,
    format: 'json',
    source_type: 'paste',
    name: 'My API'
  }
});

// Generate MCP server
if (data?.valid) {
  const { data: deployment } = await supabase.functions.invoke('generate-mcp-server', {
    body: {
      api_spec_id: data.api_spec_id,
      deployment_name: 'my-mcp-server'
    }
  });
}
```

### Python

```python
import requests

# Validate OpenAPI spec
response = requests.post(
    'https://nqfciqtsrcjorlqcglmq.supabase.co/functions/v1/validate-openapi',
    headers={
        'Authorization': f'Bearer {jwt_token}',
        'Content-Type': 'application/json'
    },
    json={
        'content': openapi_spec,
        'format': 'json',
        'source_type': 'paste',
        'name': 'My API'
    }
)
```

### cURL Examples

See individual function sections above for comprehensive cURL examples.

---

*Complete API reference for all Edge Functions in the platform.* ðŸ“š 
