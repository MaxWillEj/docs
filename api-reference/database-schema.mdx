---
title: Database Schema
description: Database structure and relationships
icon: database
---
# Database Schema Documentation

This document provides comprehensive documentation of the PostgreSQL database schema used by the Tydli platform.

## Overview

The database schema uses Row Level Security (RLS) policies on all tables to ensure proper data access control. For a complete list of tables, see the [Table Definitions](#table-definitions) section below.

**Core Application Tables:**
- `profiles` - Extended user profile information
- `api_specs` - Uploaded OpenAPI specifications
- `deployments` - MCP server deployment tracking
- `mcp_endpoints` - Parsed API endpoints from specifications
- `mcp_server_registry` - Active MCP server routing registry
- `deployment_logs` - Structured logging for deployments

**Authentication & OAuth:**
- `email_verification_tokens` - Email verification for new accounts
- `oauth_clients` - OAuth 2.1 client registrations
- `oauth_authorization_codes` - Authorization codes with PKCE
- `oauth_access_tokens` - OAuth access tokens
- `oauth_refresh_tokens` - OAuth refresh tokens (prepared for future use)
- `oauth_pending_auth` - Temporary OAuth state storage
- `oauth_rate_limits` - Rate limiting for OAuth endpoints

**Security & Credentials:**
- `api_credentials` - Encrypted API credentials for target APIs
- `security_events` - Security audit log
- `user_roles` - Role-based access control (admin, user)

**Usage & Billing:**
- `user_limits` - Per-user quotas and rate limits
- `plan_templates` - Subscription plan definitions
- `request_usage_tracking` - MCP request usage analytics
- `ai_usage_tracking` - AI document processing usage

**Gallery & Marketplace:**
- `gallery_items` - Public marketplace of pre-built MCP servers
- `gallery_impressions` - Analytics for gallery views and clicks
- `gallery_deployments` - Deployment conversion tracking

**Testing & Security Audit:**
- `api_connection_tests` - API connection test results
- `deployment_secret_access_log` - Security audit log for credential access

**Observability:**
- `tool_invocation_logs` - Detailed tool-level debugging logs

**Total Tables:** 26

## Table Definitions

### 1. profiles

Extended user profile information beyond Supabase Auth.

```sql
CREATE TABLE public.profiles (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL UNIQUE,
  display_name TEXT NULL,
  username TEXT NULL,
  company_name TEXT NULL,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (user_id)`

**RLS Policies**:
- `SELECT`: Users can view their own profile (`auth.uid() = user_id`)
- `INSERT`: Users can create their own profile (`auth.uid() = user_id`)
- `UPDATE`: Users can update their own profile (`auth.uid() = user_id`)

**Triggers**:
- `update_profiles_updated_at`: Automatically updates `updated_at` on UPDATE
- `on_auth_user_created`: Creates profile when user signs up (calls `handle_new_user()`)

### 2. api_specs

Stores validated OpenAPI specifications uploaded by users.

```sql
CREATE TABLE public.api_specs (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL,
  deployment_id UUID NULL,
  name TEXT NOT NULL,
  content JSONB NOT NULL,
  format TEXT NOT NULL,                    -- 'json' | 'yaml'
  source_type TEXT NOT NULL,               -- 'upload' | 'paste' | 'url'
  source_url TEXT NULL,
  file_path TEXT NULL,
  file_size INTEGER NULL,
  version TEXT NULL,                       -- OpenAPI version
  validation_status TEXT DEFAULT 'pending'::text,  -- 'pending' | 'valid' | 'invalid'
  validation_errors JSONB DEFAULT '[]'::jsonb,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `INDEX idx_api_specs_user_id ON api_specs(user_id)`
- `INDEX idx_api_specs_validation_status ON api_specs(validation_status)`

**RLS Policies**:
- `SELECT`: Users view own specs (`auth.uid() = user_id`)
- `INSERT`: Users create own specs (`auth.uid() = user_id` AND deployment check)
- `UPDATE`: Users update own specs (`auth.uid() = user_id` AND deployment check)
- `DELETE`: Users delete own specs (`auth.uid() = user_id`)

### 3. deployments

Tracks MCP server deployments and lifecycle status.

```sql
CREATE TABLE public.deployments (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL,
  name TEXT NOT NULL,
  slug TEXT NOT NULL UNIQUE,
  status deployment_status NOT NULL DEFAULT 'generating'::deployment_status,
  openapi_spec JSONB NOT NULL,
  endpoint_count INTEGER DEFAULT 0,
  api_base_url TEXT NULL,
  auth_config JSONB DEFAULT '{}'::jsonb,
  mcp_auth_method TEXT DEFAULT 'oauth'::text,  -- 'oauth' | 'jwt' | 'none'
  mcp_jwt_token TEXT NULL,                     -- Static JWT for 'jwt' auth method
  mcp_server_url TEXT NULL,
  docs_url TEXT NULL,
  deployment_config JSONB DEFAULT '{}'::jsonb,
  error_message TEXT NULL,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Enums**:
```sql
CREATE TYPE deployment_status AS ENUM (
  'generating',   -- Initial creation
  'deploying',    -- Registration in progress
  'ready',        -- Live and accessible
  'stopped',      -- Inactive
  'error'         -- Generation or runtime error
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (slug)`
- `INDEX idx_deployments_user_id ON deployments(user_id)`
- `INDEX idx_deployments_status ON deployments(status)`

**RLS Policies**:
- `SELECT`: Users view own deployments (`auth.uid() = user_id`)
- `INSERT`: Users create own deployments (`auth.uid() = user_id`)
- `UPDATE`: Users update own deployments (`auth.uid() = user_id`)
- `DELETE`: Users delete own deployments (`auth.uid() = user_id`)

### 4. mcp_endpoints

Stores parsed endpoint information extracted from OpenAPI specifications.

```sql
CREATE TABLE public.mcp_endpoints (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  deployment_id UUID NOT NULL REFERENCES deployments(id) ON DELETE CASCADE,
  path TEXT NOT NULL,
  method TEXT NOT NULL,
  operation_id TEXT NULL,
  summary TEXT NULL,
  description TEXT NULL,
  parameters JSONB DEFAULT '[]'::jsonb,
  request_schema JSONB DEFAULT '{}'::jsonb,
  response_schema JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `INDEX idx_mcp_endpoints_deployment_id ON mcp_endpoints(deployment_id)`
- `INDEX idx_mcp_endpoints_path_method ON mcp_endpoints(path, method)`

**RLS Policies**:
- `SELECT`: Users view endpoints for their deployments (via deployment ownership check)

### 5. mcp_server_registry

Registry of active MCP servers for dynamic routing.

```sql
CREATE TABLE public.mcp_server_registry (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  deployment_id UUID NOT NULL REFERENCES deployments(id) ON DELETE CASCADE,
  slug TEXT NOT NULL UNIQUE,
  status TEXT NOT NULL DEFAULT 'active'::text,  -- 'active' | 'inactive'
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Note**: The `server_code` column was removed for security. Responses are now generated dynamically from OpenAPI specs stored in the `deployments` table.

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (slug)`
- `INDEX idx_mcp_server_registry_deployment_id ON mcp_server_registry(deployment_id)`
- `INDEX idx_mcp_server_registry_status ON mcp_server_registry(status)`

**RLS Policies**:
- `SELECT`: Users view their own MCP servers (via deployment ownership)

### 6. deployment_logs

Structured logging for deployment operations with enhanced error tracking.

```sql
CREATE TABLE public.deployment_logs (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  deployment_id UUID NOT NULL REFERENCES deployments(id) ON DELETE CASCADE,
  level TEXT NOT NULL DEFAULT 'info'::text,  -- 'info' | 'error' | 'debug' | 'warn'
  message TEXT NOT NULL,
  metadata JSONB DEFAULT '{}'::jsonb,
  operation TEXT NULL,                       -- 'start' | 'stop' | 'health_check' | 'authentication' etc.
  status TEXT NULL CHECK (status IN ('success', 'failure', 'pending', 'warning')),
  error_details JSONB NULL,                  -- Structured error information
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `INDEX idx_deployment_logs_deployment_id ON deployment_logs(deployment_id)`
- `INDEX idx_deployment_logs_created_at ON deployment_logs(created_at DESC)`
- `INDEX idx_deployment_logs_level ON deployment_logs(level)`
- `INDEX idx_deployment_logs_operation ON deployment_logs(operation, created_at DESC)`
- `INDEX idx_deployment_logs_status ON deployment_logs(status, created_at DESC)`

**RLS Policies**:
- `SELECT`: Users view logs for their deployments
- `INSERT`: Service role can insert logs

### 7. email_verification_tokens

> **⚠️ CURRENT STATUS:** This table is UNUSED as of 2025-01-23  
> **Reason:** Custom email verification system disabled  
> **See:** [Email Authentication Configuration](../operations/EMAIL_AUTHENTICATION.md)
>
> **Options:**  
> 1. Keep table for potential future re-enablement of custom emails (recommended)  
> 2. Drop table if custom emails never needed again

Email verification tokens for custom verification flow (currently disabled).

```sql
CREATE TABLE public.email_verification_tokens (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL,
  token TEXT NOT NULL UNIQUE,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (now() + INTERVAL '24 hours'),
  used BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (token)`
- `INDEX idx_email_verification_tokens_user_id ON email_verification_tokens(user_id)`
- `INDEX idx_email_verification_tokens_token ON email_verification_tokens(token)`

**RLS Policies**:
- `ALL`: Service role only (`auth.jwt() ->> 'role' = 'service_role'`)

**Related Edge Functions**:
- `create-verification-token` - Generates token, stores in DB, sends email
- `verify-email` - Validates token, confirms email, marks token as used
- `send-auth-email` - Sends verification emails via Resend

### 8. oauth_clients

OAuth 2.1 client registrations for AI agents.

```sql
CREATE TABLE public.oauth_clients (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  client_id TEXT NOT NULL UNIQUE,
  client_secret TEXT NULL,
  client_name TEXT NOT NULL,
  redirect_uris TEXT[] NOT NULL,
  grant_types TEXT[] DEFAULT ARRAY['authorization_code'::text],
  response_types TEXT[] DEFAULT ARRAY['code'::text],
  scope TEXT DEFAULT 'openid email'::text,
  is_public BOOLEAN DEFAULT true,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (client_id)`

**RLS Policies**:
- `SELECT`: Service role (`auth.jwt() ->> 'role' = 'service_role'`)
- `SELECT`: Authenticated users can view client metadata
- `SELECT`: Users can view OAuth clients for own deployments (via metadata->deployment_id)
- `ALL`: Service role can manage clients

### 9. oauth_authorization_codes

Authorization codes with PKCE support.

```sql
CREATE TABLE public.oauth_authorization_codes (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  code TEXT NOT NULL UNIQUE,
  client_id TEXT NOT NULL,
  user_id UUID NOT NULL,
  redirect_uri TEXT NOT NULL,
  scope TEXT NULL,
  code_challenge TEXT NOT NULL,
  code_challenge_method TEXT NOT NULL DEFAULT 'S256'::text,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  used BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (code)`

**RLS Policies**:
- `SELECT`: Service role and users can view own codes
- `ALL`: Service role can manage authorization codes

### 10. oauth_access_tokens

OAuth access tokens for authenticated MCP access.

```sql
CREATE TABLE public.oauth_access_tokens (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  access_token TEXT NOT NULL UNIQUE,
  client_id TEXT NOT NULL,
  user_id UUID NOT NULL,
  scope TEXT NULL,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  revoked BOOLEAN DEFAULT false,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (access_token)`
- `INDEX idx_oauth_access_tokens_user_id ON oauth_access_tokens(user_id)`

**RLS Policies**:
- `SELECT`: Service role and users can view own tokens
- `UPDATE`: Users can revoke own tokens (set `revoked = true`)
- `ALL`: Service role can manage access tokens

### 11. oauth_refresh_tokens

Refresh tokens for OAuth token refresh flow.

```sql
CREATE TABLE public.oauth_refresh_tokens (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  refresh_token TEXT NOT NULL UNIQUE,
  access_token_id UUID NULL,
  client_id TEXT NOT NULL,
  user_id UUID NOT NULL,
  scope TEXT NOT NULL,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  revoked BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

**Columns**:
- `scope` - OAuth scopes associated with this refresh token

**Token Refresh Flow**:
- Refresh tokens have 30-day expiration (configurable)
- Used to obtain new access tokens without re-authentication
- Linked to original access token via `access_token_id`
- See `mcp-oauth-server` edge function for implementation details

**RLS Policies**:
- `SELECT`: Service role and users can view own tokens
- `ALL`: Service role can manage refresh tokens

### 12. oauth_pending_auth

Temporary storage for OAuth state during authorization flow.

```sql
CREATE TABLE public.oauth_pending_auth (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  state_token TEXT NOT NULL UNIQUE,
  client_id TEXT NOT NULL,
  redirect_uri TEXT NOT NULL,
  scope TEXT NOT NULL DEFAULT 'openid email'::text,
  code_challenge TEXT NOT NULL,
  code_challenge_method TEXT NOT NULL DEFAULT 'S256'::text,
  original_state TEXT NULL,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (now() + INTERVAL '5 minutes'),
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (state_token)`

**RLS Policies**:
- `ALL`: Service role only (WITH CHECK true)

**Related Functions**:
- `store_oauth_state()` - Stores OAuth parameters, returns state_token
- `retrieve_oauth_state()` - One-time retrieval (deletes after use)
- `cleanup_expired_oauth_states()` - Removes expired state tokens

### 13. oauth_rate_limits

Rate limiting tracking for OAuth endpoints.

```sql
CREATE TABLE public.oauth_rate_limits (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  identifier TEXT NOT NULL,                -- IP address or client_id
  endpoint TEXT NOT NULL,                  -- 'register' | 'authorize' | 'token'
  request_count INTEGER NOT NULL DEFAULT 1,
  window_start TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  UNIQUE (identifier, endpoint, window_start)
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (identifier, endpoint, window_start)`

**RLS Policies**:
- `ALL`: Service role only (USING true WITH CHECK true)

**Related Function**:
- `check_oauth_rate_limit(identifier, endpoint, max_requests, window_minutes)` - Returns allowed/denied with retry_after

### 14. api_credentials

Encrypted API credentials for authenticated endpoints.

```sql
CREATE TABLE public.api_credentials (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL,
  deployment_id UUID NULL,
  credential_type TEXT NOT NULL,           -- 'api_key' | 'bearer_token' | 'oauth2'
  encrypted_credentials JSONB NOT NULL,    -- AES-256 encrypted via pgcrypto
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `INDEX idx_api_credentials_user_id ON api_credentials(user_id)`
- `INDEX idx_api_credentials_deployment_id ON api_credentials(deployment_id)`

**RLS Policies**:
- `SELECT`: Users view own credentials (`auth.uid() = user_id`)
- `INSERT`: Users create credentials for own deployments
- `UPDATE`: Users update credentials for own deployments
- `DELETE`: Users delete own credentials (`auth.uid() = user_id`)

**Related Functions**:
- `encrypt_credential(plaintext, key)` - AES-256 encryption
- `decrypt_credential(ciphertext, key)` - AES-256 decryption

**Related Edge Functions**:
- `store-credentials` - Server-side encryption endpoint
- `retrieve-credentials` - Server-side decryption endpoint

### 15. security_events

Security audit log for tracking authentication and security events.

```sql
CREATE TABLE public.security_events (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NULL,
  event_type TEXT NOT NULL,                -- 'login_success' | 'login_failed' | 'token_rotation' | etc.
  event_details JSONB DEFAULT '{}'::jsonb,
  ip_address INET NULL,
  user_agent TEXT NULL,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `INDEX idx_security_events_user_id ON security_events(user_id)`
- `INDEX idx_security_events_created_at ON security_events(created_at DESC)`

**RLS Policies**:
- `SELECT`: Users view own security events (`auth.uid() = user_id`)

**Related Function**:
- `log_security_event(event_type, event_details, target_user_id)` - Logs security events
- `get_user_security_summary(target_user_id)` - Returns security statistics

### 16. user_roles

Role-based access control (prevents privilege escalation).

```sql
CREATE TYPE app_role AS ENUM ('admin', 'moderator', 'user');

CREATE TABLE public.user_roles (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL,
  role app_role NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  created_by UUID NULL,
  UNIQUE (user_id, role)
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (user_id, role)`

**RLS Policies**:
- `SELECT`: Users view own roles (`user_id = auth.uid()`)
- `INSERT/UPDATE/DELETE`: Admins only (uses `has_role()` function)

**Related Function**:
- `has_role(_user_id, _role)` - Security definer function to check roles (prevents RLS recursion)

### 17. user_limits

User-specific quotas and rate limits.

```sql
CREATE TABLE public.user_limits (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL UNIQUE,
  plan_template_id UUID NULL REFERENCES plan_templates(id),
  max_deployments INTEGER NOT NULL DEFAULT 10,
  max_endpoints_per_deployment INTEGER NOT NULL DEFAULT 50,
  max_total_endpoints INTEGER NOT NULL DEFAULT 100,
  requests_per_month INTEGER NOT NULL DEFAULT 1000,
  requests_per_hour INTEGER NOT NULL DEFAULT 20,
  gallery_deploys_per_hour INTEGER NOT NULL DEFAULT 10,
  gallery_deploys_per_day INTEGER NOT NULL DEFAULT 50,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (user_id)`
- `INDEX idx_user_limits_plan_template_id ON user_limits(plan_template_id)`

**RLS Policies**:
- `SELECT/INSERT/UPDATE`: Users manage own limits (`auth.uid() = user_id`)

**Triggers**:
- `on_auth_user_created`: Automatically assigns 'free' plan to new users (calls `initialize_user_limits()`)

**Related Functions**:
- `get_user_limits(target_user_id)` - Returns user quotas
- `assign_plan_to_user(target_user_id, plan_name)` - Admin-only plan assignment
- `assign_plan_to_user_internal(target_user_id, plan_name)` - System/trigger use

### 18. plan_templates

Subscription plan definitions.

```sql
CREATE TABLE public.plan_templates (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,               -- 'free' | 'pro' | 'enterprise'
  display_name TEXT NOT NULL,
  description TEXT NULL,
  price_cents INTEGER DEFAULT 0,
  max_deployments INTEGER NOT NULL,
  max_endpoints_per_deployment INTEGER NOT NULL,
  max_total_endpoints INTEGER NOT NULL,
  requests_per_month INTEGER NOT NULL,
  requests_per_hour INTEGER NOT NULL,
  gallery_deploys_per_hour INTEGER NOT NULL DEFAULT 10,
  gallery_deploys_per_day INTEGER NOT NULL DEFAULT 50,
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `UNIQUE (name)`
- `INDEX idx_plan_templates_is_active ON plan_templates(is_active)`

**RLS Policies**:
- `SELECT`: Anyone can view active plans (`is_active = true`)

### 19. request_usage_tracking

MCP request usage analytics with performance monitoring.

```sql
CREATE TABLE public.request_usage_tracking (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL,
  deployment_id UUID NOT NULL,
  method TEXT NOT NULL,
  path TEXT NOT NULL,
  response_status INTEGER NULL,
  response_time_ms INTEGER NULL,            -- Response time in milliseconds for performance tracking
  request_timestamp TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  ip_address INET NULL,
  user_agent TEXT NULL,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `INDEX idx_request_usage_tracking_user_id ON request_usage_tracking(user_id)`
- `INDEX idx_request_usage_tracking_deployment_id ON request_usage_tracking(deployment_id)`
- `INDEX idx_request_usage_tracking_timestamp ON request_usage_tracking(request_timestamp DESC)`
- `INDEX idx_request_usage_tracking_response_time ON request_usage_tracking(response_time_ms)` (partial, where not null)

**RLS Policies**:
- `SELECT`: Users view own usage (`auth.uid() = user_id`)
- `INSERT`: Service role can insert usage data

**Related Functions**:
- `get_current_usage(target_user_id)` - Returns current usage statistics
- `check_rate_limits(target_user_id)` - Validates against user limits
- `reset_user_usage(target_user_id)` - Resets user usage counters
- `cleanup_old_request_tracking()` - Archives data older than 90 days

### 20. ai_usage_tracking

AI document processing usage tracking.

```sql
CREATE TABLE public.ai_usage_tracking (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL,
  request_type TEXT NOT NULL DEFAULT 'document_processing'::text,
  document_name TEXT NULL,
  document_size_bytes INTEGER NULL,
  processing_time_ms INTEGER NULL,
  model_used TEXT NOT NULL DEFAULT 'gemini-2.0-flash'::text,
  success BOOLEAN NOT NULL,
  error_message TEXT NULL,
  request_date DATE NOT NULL DEFAULT CURRENT_DATE,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `INDEX idx_ai_usage_tracking_user_id_date ON ai_usage_tracking(user_id, request_date)`

**RLS Policies**:
- `SELECT`: Users view own AI usage (`auth.uid() = user_id`)
- `INSERT`: System can track AI usage (`auth.uid() = user_id`)

**Related Functions**:
- `can_process_ai_document(target_user_id)` - Returns daily usage and remaining quota
- `log_ai_usage(p_user_id, p_document_name, p_document_size, p_processing_time, p_success, p_error_message)` - Logs AI usage
- `get_ai_usage_summary(target_user_id)` - Returns usage statistics
- `cleanup_old_ai_usage()` - Removes data older than 90 days

**Daily Limits**: 5 successful AI processing requests per user per day

### 21. tool_invocation_logs

Detailed logging for MCP tool invocations (for debugging and analytics).

```sql
CREATE TABLE public.tool_invocation_logs (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  deployment_id UUID NOT NULL REFERENCES deployments(id) ON DELETE CASCADE,
  request_id TEXT NOT NULL,
  tool_name TEXT NOT NULL,
  mcp_params JSONB NULL,                    -- Parameters passed to MCP tool
  api_method TEXT NULL,                     -- HTTP method used for API call
  api_url TEXT NULL,                        -- Target API endpoint
  api_response_status INTEGER NULL,         -- API response status code
  execution_time_ms INTEGER NULL,           -- Tool execution time
  success BOOLEAN NOT NULL,
  error_message TEXT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**Indexes**:
- `PRIMARY KEY (id)`
- `INDEX idx_tool_invocations_deployment ON tool_invocation_logs(deployment_id, created_at DESC)`
- `INDEX idx_tool_invocations_request ON tool_invocation_logs(request_id)`
- `INDEX idx_tool_invocations_user ON tool_invocation_logs(user_id, created_at DESC)`
- `INDEX idx_tool_invocations_success ON tool_invocation_logs(success, created_at DESC)`

**RLS Policies**:
- `SELECT`: Users can view their own tool invocation logs
- `INSERT`: Service role can insert logs

**Usage Notes**:
- Currently prepared but not actively populated
- Can be enabled for detailed debugging when needed
- Tracks individual tool calls within MCP requests

### 22. gallery_items

Public gallery/marketplace of pre-built MCP servers that users can discover and deploy.

```sql
CREATE TABLE public.gallery_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  deployment_id UUID REFERENCES deployments(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  short_description TEXT NOT NULL,
  long_description TEXT,
  category TEXT NOT NULL,
  tags TEXT[] DEFAULT '{}',
  icon_url TEXT,
  screenshot_urls TEXT[] DEFAULT '{}',
  demo_video_url TEXT,
  api_base_url TEXT,
  auth_method TEXT,
  endpoint_count INTEGER DEFAULT 0,
  docs_url TEXT,
  example_queries TEXT[],
  use_cases TEXT[],
  is_public BOOLEAN DEFAULT false,
  is_featured BOOLEAN DEFAULT false,
  view_count INTEGER DEFAULT 0,
  deploy_count INTEGER DEFAULT 0,
  popularity_score FLOAT DEFAULT 0.0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Indexes**:
- `UNIQUE (slug)`
- `INDEX idx_gallery_items_public ON gallery_items(is_public, popularity_score DESC)`
- `INDEX idx_gallery_items_featured ON gallery_items(is_featured, created_at DESC)`
- `INDEX idx_gallery_items_category ON gallery_items(category, popularity_score DESC)`

**RLS Policies**:
- `SELECT`: Public can view `is_public = true` items; owners can view their own
- `INSERT/UPDATE/DELETE`: Only item owners

### 23. gallery_impressions

Analytics tracking for gallery page views and deployment clicks.

```sql
CREATE TABLE public.gallery_impressions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  gallery_item_id UUID REFERENCES gallery_items(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  event_type TEXT NOT NULL CHECK (event_type IN ('view', 'deploy_click')),
  page_url TEXT,
  referrer TEXT,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Indexes**:
- `INDEX idx_gallery_impressions_item ON gallery_impressions(gallery_item_id, created_at DESC)`
- `INDEX idx_gallery_impressions_event ON gallery_impressions(event_type, created_at DESC)`

**RLS Policies**:
- `INSERT`: Authenticated users can log impressions
- `SELECT`: Gallery item owners can view their analytics

### 24. gallery_deployments

Tracks successful deployments from gallery items for conversion analytics.

```sql
CREATE TABLE public.gallery_deployments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  gallery_item_id UUID REFERENCES gallery_items(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  deployment_id UUID REFERENCES deployments(id) ON DELETE SET NULL,
  success BOOLEAN NOT NULL,
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Indexes**:
- `INDEX idx_gallery_deployments_item ON gallery_deployments(gallery_item_id, created_at DESC)`
- `INDEX idx_gallery_deployments_user ON gallery_deployments(user_id, created_at DESC)`

**RLS Policies**:
- `INSERT`: Authenticated users can log deployment attempts
- `SELECT`: Users can view their own deployment history

### 25. api_connection_tests

Stores results of API connection tests (pre-deployment validation, post-deployment checks, manual testing).

```sql
CREATE TABLE public.api_connection_tests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  deployment_id UUID REFERENCES deployments(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  test_type TEXT NOT NULL CHECK (test_type IN ('pre_deployment', 'post_deployment', 'manual')),
  success BOOLEAN NOT NULL,
  status_code INTEGER,
  error_message TEXT,
  suggestion TEXT,
  auth_method TEXT,
  tested_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Indexes**:
- `INDEX idx_api_connection_tests_deployment ON api_connection_tests(deployment_id, tested_at DESC)`
- `INDEX idx_api_connection_tests_user ON api_connection_tests(user_id, tested_at DESC)`

**RLS Policies**:
- `SELECT`: Users can view their own test results
- `INSERT`: Authenticated users can create tests

**Usage Notes**:
- `test_type`: Indicates when the test was run (before deployment, after deployment, or manually triggered)
- `suggestion`: Provides actionable feedback for failed tests

### 26. deployment_secret_access_log

Security audit log tracking all access to deployment secrets (JWT tokens, API keys).

```sql
CREATE TABLE public.deployment_secret_access_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  deployment_id UUID REFERENCES deployments(id) ON DELETE CASCADE NOT NULL,
  user_id UUID NOT NULL,
  secret_type TEXT NOT NULL CHECK (secret_type IN ('jwt_token', 'api_key', 'all')),
  access_method TEXT NOT NULL DEFAULT 'edge_function',
  ip_address INET,
  user_agent TEXT,
  request_id TEXT,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Indexes**:
- `INDEX idx_secret_access_log_deployment ON deployment_secret_access_log(deployment_id, created_at DESC)`
- `INDEX idx_secret_access_log_user ON deployment_secret_access_log(user_id, created_at DESC)`
- `INDEX idx_secret_access_log_created ON deployment_secret_access_log(created_at DESC)`

**RLS Policies**:
- `SELECT`: Users can view access logs for their own deployments
- `INSERT`: Service role only (security audit)

**Usage Notes**:
- Logs every access to sensitive deployment credentials
- Critical for security compliance and breach detection
- Retention should be configured per compliance requirements

## Database Functions

### Trigger Functions

**update_updated_at_column()** - Auto-updates `updated_at` timestamp
- Applied to: `api_specs`, `deployments`, `mcp_server_registry`, `profiles`, `api_credentials`, `user_limits`, `plan_templates`

**handle_new_user()** - Creates profile on user signup
- Trigger: `on_auth_user_created` on `auth.users`
- Creates record in `profiles` with `display_name` from metadata

**initialize_user_limits()** - Assigns free plan to new users
- Trigger: `on_auth_user_created` on `auth.users`
- Calls `assign_plan_to_user_internal(user_id, 'free')`

### Security Functions

**encrypt_credential(plaintext, encryption_key)** → TEXT
- AES-256 encryption using pgcrypto extension
- Returns base64-encoded ciphertext

**decrypt_credential(ciphertext, encryption_key)** → TEXT
- AES-256 decryption using pgcrypto extension
- Returns plaintext string

**has_role(_user_id, _role)** → BOOLEAN
- Security definer function to check user roles
- Prevents RLS policy recursion

**log_security_event(event_type, event_details, target_user_id)** → UUID
- Logs security events with IP and user agent
- Returns event ID

**get_user_security_summary(target_user_id)** → TABLE
- Returns aggregated security statistics
- Includes login failures, token rotations, suspicious events

### OAuth Functions

**store_oauth_state(...)** → TEXT
- Stores OAuth parameters during authorization
- Returns secure state_token
- Cleans up expired states automatically

**retrieve_oauth_state(state_token)** → TABLE
- One-time retrieval (deletes after use)
- Returns client_id, redirect_uri, scope, code_challenge, etc.

**check_oauth_rate_limit(identifier, endpoint, max_requests, window_minutes)** → TABLE
- Returns: allowed (boolean), current_count, retry_after
- Automatically cleans up old entries
- Increments counter on success

**cleanup_expired_oauth_data()** → INTEGER
- Removes expired authorization codes, access tokens, refresh tokens
- Returns total deleted count

**cleanup_expired_oauth_states()** → INTEGER
- Removes expired OAuth pending auth records

**validate_redirect_uris(uris[])** → BOOLEAN
- Validates redirect URI array (1-10 URIs, <500 chars each)
- Enforces HTTPS except for localhost
- Prevents wildcard domains

### Usage & Limit Functions

**get_user_limits(target_user_id)** → TABLE
- Returns: max_deployments, max_endpoints_per_deployment, max_total_endpoints, requests_per_month, requests_per_hour, gallery_deploys_per_hour, gallery_deploys_per_day, plan_name
- ⚠️ **Known Issue**: The fallback values (when user has no user_limits record) for gallery deployment limits are incorrect in the function definition. The fallback returns `gallery_deploys_per_hour: 10` and `gallery_deploys_per_day: 50`, but the Free plan template specifies `5` and `20` respectively. This affects users without explicit user_limits records. See migration `20251108202227_f523ffb2-9e00-4ab3-a8d4-574d5f39b28b.sql` line 205 for the code fix location.

**get_current_usage(target_user_id)** → TABLE
- Returns: deployment_count, total_endpoint_count, requests_this_hour, requests_this_month

**can_create_deployment(target_user_id, estimated_endpoint_count)** → TABLE
- Returns: can_create (boolean), reason, current/max deployments, current/max endpoints

**check_rate_limits(target_user_id)** → TABLE
- Returns: within_hourly_limit, within_monthly_limit, requests and limits

**check_and_log_rate_limits(target_user_id)** → TABLE
- Checks limits and logs warning/exceeded events
- Returns: within_limits, warning_threshold_reached, current_usage (JSONB)

**assign_plan_to_user(target_user_id, plan_name)** → BOOLEAN
- Admin-only function to assign plans
- Logs plan assignment in security_events

**assign_plan_to_user_internal(target_user_id, plan_name)** → BOOLEAN
- Internal version without admin check
- Used by triggers and system functions

**reset_user_usage(target_user_id)** → TABLE
- Resets usage tracking for specific user
- Returns deleted_count

**reset_monthly_usage()** → TABLE
- Resets all usage older than current month
- Returns deleted_count

**reset_all_usage()** → TABLE
- Resets all usage tracking
- Returns deleted_count

**cleanup_old_request_tracking()** → INTEGER
- Removes usage data older than 90 days
- Returns deleted count

### AI Usage Functions

**can_process_ai_document(target_user_id)** → TABLE
- Returns: can_process (boolean), daily_usage, daily_limit (5), remaining
- Enforces 5 successful requests per day

**log_ai_usage(p_user_id, p_document_name, p_document_size, p_processing_time, p_success, p_error_message)** → UUID
- Logs AI processing attempt
- Returns usage record ID

**get_ai_usage_summary(target_user_id)** → TABLE
- Returns: today_usage, today_remaining, this_week_usage, this_month_usage, total_usage, success_rate

**cleanup_old_ai_usage()** → INTEGER
- Removes AI usage data older than 90 days

### Gallery Functions

**update_gallery_popularity()** - TRIGGER
- Automatically calculates `popularity_score` for gallery items
- Triggered on changes to `view_count` and `deploy_count`
- Formula balances views and deployments with time decay

**validate_gallery_auth_config(p_gallery_item_id UUID)** → BOOLEAN
- Validates gallery item authentication configuration
- Ensures auth_method matches deployment settings
- Returns validation status

**cleanup_old_gallery_analytics()** → INTEGER
- Removes gallery impression data older than retention period
- Optimizes analytics table performance
- Returns count of deleted records

**increment_gallery_view_count(p_gallery_item_id UUID)** → VOID
- Atomically increments `view_count` for a gallery item
- Called when users view item details
- Triggers popularity score recalculation

**increment_gallery_deploy_count(p_gallery_item_id UUID)** → VOID
- Atomically increments `deploy_count` for a gallery item
- Called after successful deployment from gallery
- Triggers popularity score recalculation

### Admin & Utility Functions

**migrate_all_refresh_tokens_to_hash()** → INTEGER
- One-time migration utility for OAuth token security upgrade
- Hashes existing plaintext refresh tokens
- Returns count of migrated tokens

**get_usage_summary()** → TABLE
- Returns aggregated usage statistics across all users (admin only)
- Includes deployment counts, request totals, API usage
- Used for platform analytics and capacity planning

**reset_usage_before_date(cutoff_date TIMESTAMPTZ)** → INTEGER
- Resets usage counters for data before specified date
- Used for billing cycle resets or data cleanup
- Returns count of affected records
- **Warning**: Admin function - use with caution

## Relationships

### Entity Relationship Diagram

```
auth.users (Supabase managed)
  ↓ (via trigger)
profiles ──────────────────┬─── user_limits ← plan_templates
  │                        │
  ├─── api_specs           ├─── user_roles
  │                        │
  ├─── deployments ────────┼─── api_credentials
  │      │                 │
  │      ├─ mcp_endpoints  ├─── email_verification_tokens
  │      │                 │
  │      ├─ deployment_logs├─── oauth_access_tokens ← oauth_clients
  │      │                 │         │
  │      ├─ mcp_server_    ├─── oauth_authorization_codes
  │      │   registry      │
  │      │                 ├─── oauth_refresh_tokens
  │      └─ request_usage_ │
  │          tracking      ├─── security_events
  │                        │
  └────────────────────────└─── ai_usage_tracking

oauth_pending_auth (temporary storage, no FK)
oauth_rate_limits (tracking table, no FK)
```

## Storage Buckets

### api-specs
- **Public**: No (private bucket)
- **Purpose**: Stores uploaded OpenAPI specification files
- **File Types**: JSON, YAML
- **Size Limit**: 10MB per file
- **RLS Policies**: User-scoped access via RLS

## Summary Statistics

- **Total Tables**: 21
- **Tables with RLS**: 21 (100%)
- **Database Functions**: 24+
- **Edge Functions**: 14
- **Storage Buckets**: 1
- **PostgreSQL Extensions**: pgcrypto (for AES-256 encryption)

---

*Last Updated: October 16, 2025*  
*Schema Version: Production v1.0*
 
